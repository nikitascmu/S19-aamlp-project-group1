---
title: "ML Pipeline Project Code"
author: "Lauren Rost, Mridul Singh Gangawar, Nikita Setia"
date: "March 19, 2019"
output: html_document
---

```{r, message=FALSE, warning=FALSE}
#--- Loading helper files 
loadlibs = function(libs) {
  for(lib in libs) {
    class(lib)
    if(!do.call(require,as.list(lib))) {install.packages(lib)}
    do.call(require,as.list(lib))
  }
}
libs = c("tidyr","magrittr","purrr","dplyr","stringr","readr","data.table", "mice", 
         "randomForest", "ada", "gbm", "caret", "e1071", "ROCR", "ggplot2", "glmnet", "readxl")
loadlibs(libs)

mode_fun <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

#--- setting global decimal print setting
options(scipen=4)

prog = fread("program_activity.csv") %>% as_tibble() 
dem = fread("demographic.csv") %>% as_tibble() 
presc = fread("opiate_prescription_fills.csv") %>% as_tibble()

```

```{r, message=FALSE, warning=FALSE}

summary(dem %>% mutate_if(is.character, as.factor))

# missing data for RACE and GENDER
# merging native hawaiian/pacific islander + no data = no data and other because the former is too small
# merging transgendered male to female and no data = no data and other because former is too small
# dealing with missingness by allowing it to be its own category - because most likely MNAR
```

```{r, message=FALSE, warning=FALSE}

dem$RACE[which(grepl("No Data", dem$RACE))] = "No Data and Other"
dem$RACE[which(grepl("Native Hawaiian", dem$RACE))] = "No Data and Other"
dem$GENDER[which(grepl("No Data", dem$GENDER))] = "No Data and Other"
dem$GENDER[which(grepl("Transgendered", dem$GENDER))] = "No Data and Other"

colnames(dem) = c("PERSON_ID", "race", "gender")
summary(dem %>% mutate_if(is.character, as.factor))
```


```{r, message=FALSE, warning=FALSE}

summary(prog)

# No missing values in the program data 
# Overdose date and opiate overdose has NAs for individuals who have not overdosed, 
# so that is meaningful and not actually missing

```

```{r, message=FALSE, warning=FALSE}

prog = prog %>% separate(OVERDOSE_DATE, c("OVERDOSE_YEAR", "OVERDOSE_MONTH"), remove=FALSE, sep=4)

prog$OPIATE_OVERDOSE[which(grepl(0, prog$OPIATE_OVERDOSE))] = "Non-Opiate Overdose"
prog$OPIATE_OVERDOSE[which(grepl(1, prog$OPIATE_OVERDOSE))] = "Opiate Overdose"
prog$OPIATE_OVERDOSE[which(is.na(prog$OPIATE_OVERDOSE))] = "No Overdose"

summary(prog %>% mutate_if(is.character, as.factor))


```

```{r, message=FALSE, warning=FALSE}

times_used = prog %>% group_by(PERSON_ID) %>% select(YEAR, MONTH) %>% summarise(times_used = max(sequence(n())))

prog_summary = prog %>% group_by(PERSON_ID) %>% summarise(total_cyfchild = sum(CYFCHILD),
                                                          total_cyfparent = sum(CYFPARENT),
                                                          total_mh = sum(MH),
                                                          total_da = sum(DA),
                                                          total_rx = sum(RX),
                                                          total_acj = sum(ACJ),
                                                          total_cr_cases = sum(MDJS_CR_CASES),
                                                          total_cr_drug_cases = sum(MDJS_CR_DRUG_CASES))

outcome_df = prog %>% group_by(PERSON_ID) %>% 
  summarise(od_date = max(OVERDOSE_DATE), od_year = max(OVERDOSE_YEAR), 
            od_month = max(OVERDOSE_MONTH), od_type = max(OPIATE_OVERDOSE))

```


```{r, message=FALSE, warning=FALSE}

summary(presc %>% mutate_if(is.character, as.factor))

```

```{r, warning=FALSE, message=FALSE}

age_df = presc %>% group_by(PERSON_ID) %>% summarise(min_age = min(AGE), max_age = max(AGE), mean_age = mean(AGE))

age_df = age_df %>% group_by(PERSON_ID) %>% mutate(age = if_else(min_age<0, max_age, min_age)) %>%
  mutate(age = if_else(age<0, 999, age))

age_df$age[which(age_df$age>99)] = NA

summary(age_df)


```

```{r, message=FALSE, warning=FALSE}
presc_raw = presc
presc_raw$drug_strength <- str_extract(presc_raw$LABEL_NAME, "[0-9].*")

# drug strength indicated that these are oral solutions per 5ML, so made this change manually
presc_raw$drug_strength[which(grepl('ORAL SOLUTION', presc_raw$extract_strength))] <- "5-325/5ML"
presc_raw$drug_strength[which(grepl('NALOXONE', presc_raw$LABEL_NAME))] <- "50MG-0.5MG"
presc_raw = presc_raw %>% mutate(drug_strength = if_else(is.na(drug_strength), DRUG_STRENGTH, drug_strength))

# Creating a new column 'num_strength' that keeps only numeric values from 'drug_strength'
presc_raw$num_strength <- str_extract(presc_raw$drug_strength, "[0-9]*.*[0-9]")

presc_raw <- separate(presc_raw, num_strength, c("opioid_strength", "compound_strength"), sep = '-')
presc_raw <- separate(presc_raw, opioid_strength, c("opioid", "divisor"), sep = '/')
presc_raw$opioid <- str_extract(presc_raw$opioid, "[0-9]*.*[0-9]")
presc_raw <- separate(presc_raw, compound_strength, c("compound", "divisor2"), sep = '/')
#sum(presc_raw$divisor==presc_raw$divisor2,na.rm=TRUE)
presc_raw = presc_raw %>% mutate(divisor = if_else(is.na(divisor), divisor2, divisor))
presc_raw = presc_raw %>% select(-divisor2)
presc_raw = presc_raw %>% mutate(opioid = if_else(is.na(compound), opioid, 
                                                  if_else(opioid>compound, compound, opioid)))
presc_raw$divisor[which(is.na(presc_raw$divisor))] = 1
presc_raw$compound[which(is.na(presc_raw$compound))] = 1

presc_raw = presc_raw %>% mutate(opioid_converted = as.numeric(opioid)/as.numeric(divisor))

```

```{r}

presc_raw <- presc_raw %>% 
  mutate(conversion_factor = 
    if_else(grepl('BUPRENORPHINE', GENERIC_NAME) & grepl('PATCH', DOSAGE_FORM_DESC), 12.6, 
    if_else(grepl('BUPRENORPHINE', GENERIC_NAME) & grepl('AMPUL', DOSAGE_FORM_DESC), 30,
    if_else(grepl('BUTORPHANOL', GENERIC_NAME), 7,
    if_else(grepl('CODEINE', GENERIC_NAME), 0.15,
    if_else(grepl('DIHYDROCODEINE BITARTRATE', GENERIC_NAME), 0.25,
    if_else(grepl('OPIUM', GENERIC_NAME), 1,
    if_else(grepl('FENTANYL', GENERIC_NAME) & grepl('TABLET', DOSAGE_FORM_DESC), 0.13,
    if_else(grepl('FENTANYL', GENERIC_NAME) & grepl('LOZENGE', DOSAGE_FORM_DESC), 0.13,
    if_else(grepl('FENTANYL', GENERIC_NAME) & grepl('PATCH', DOSAGE_FORM_DESC), 7.2,
    if_else(grepl('NALBUPHINE', GENERIC_NAME), 1,
    if_else(grepl('FENTANYL CITRATE', GENERIC_NAME), 0.13,
    if_else(grepl('HYDROCODONE', GENERIC_NAME), 1,
    if_else(grepl('HYDROMORPHONE', GENERIC_NAME), 4,
    if_else(grepl('LEVORPHANOL TARTRATE', GENERIC_NAME), 11,
    if_else(grepl('MEPERIDINE', GENERIC_NAME), 0.1,
    if_else(grepl('METHADONE', GENERIC_NAME) & opioid_converted<=20, 4, 
    if_else(grepl('METHADONE', GENERIC_NAME) & opioid_converted>20, 8, 
    if_else(grepl('MORPHINE', GENERIC_NAME), 1, 
    if_else(grepl('OXYCODONE', GENERIC_NAME), 1.5, 
    if_else(grepl('OXYMORPHONE', GENERIC_NAME), 3,
    if_else(grepl('PENTAZOCINE', GENERIC_NAME), 0.37,
    if_else(grepl('TAPENTADOL', GENERIC_NAME), 0.4,
    if_else(grepl('TRAMADOL', GENERIC_NAME), 0.1, 0))))))))))))))))))))))))

#unique(presc_raw$conversion_factor)

presc_raw$MME <- round((presc_raw$opioid_converted*presc_raw$DISPENSED_QTY*presc_raw$conversion_factor)/presc_raw$DAYS_SUPPLY,2)

unique(presc_raw$MME)

df = presc_raw %>% filter(grepl('PATCH', presc_raw$DOSAGE_FORM_DESC))

table(df$DOSAGE_FORM_DESC, df$GENERIC_NAME)

```



```{r, warning=FALSE, message=FALSE}


#presc %>% group_by(generic_name) %>% summarise(count = n()) %>% arrange(count)
presc <- presc %>% 
  mutate(generic_name = 
    if_else(grepl('DIHYDROCODEINE BITARTR', presc_raw$GENERIC_NAME), 'DIHYDROCODEINE BITARTRATE', 
    if_else(grepl('BUPRENORPHINE', presc_raw$GENERIC_NAME), 'BUPRENORPHINE',
    if_else(grepl('HYDROCODONE BITARTRAT', presc_raw$GENERIC_NAME), 'HYDROCODONE BITARTRATE',
    if_else(grepl('MORPHINE SULFATE', presc_raw$GENERIC_NAME), 'MORPHINE SULFATE',
    if_else(grepl('OXYCODONE', presc_raw$GENERIC_NAME), 'OXYCODONE', 
    if_else(grepl('PENTAZOCINE', presc_raw$GENERIC_NAME), 'PENTAZOCINE',
    if_else(grepl('TRAMADOL', presc_raw$GENERIC_NAME), 'TRAMADOL',
    if_else(grepl('CODEINE PHOSPHATE', presc_raw$GENERIC_NAME), 'CODEINE PHOSPHATE',
    if_else(grepl('OPIUM/BELLADONNA', presc_raw$GENERIC_NAME), 'OPIUM/BELLADONNA', 
    if_else(grepl('FENTANYL', presc_raw$GENERIC_NAME), 'FENTANYL',
    if_else(grepl('HYDROMORPHONE', presc_raw$GENERIC_NAME), 'HYDROMORPHONE', 
    if_else(grepl('MEPERIDINE', presc_raw$GENERIC_NAME), 'MEPERIDINE', GENERIC_NAME
    )))))))))))))


presc <- presc %>% 
  mutate(dosage_form = 
    if_else(grepl('TABLET', presc_raw$DOSAGE_FORM_DESC), 'PILL', 
    if_else(grepl('VIAL', presc_raw$DOSAGE_FORM_DESC), 'VIAL',
    if_else(grepl('SYRINGE', presc_raw$DOSAGE_FORM_DESC), 'VIAL',
    if_else(grepl('CAPSULE', presc_raw$DOSAGE_FORM_DESC), 'PILL', 
    if_else(grepl('PATCH', presc_raw$DOSAGE_FORM_DESC), 'PATCH',
    if_else(grepl('LOZENGE', presc_raw$DOSAGE_FORM_DESC), 'LOZENGE',
    if_else(grepl('AMPUL', presc_raw$DOSAGE_FORM_DESC), 'AMPUL',
    if_else(grepl('SPRAY', presc_raw$DOSAGE_FORM_DESC), 'SPRAY',
    if_else(grepl('SOLUTION', presc_raw$DOSAGE_FORM_DESC), 'LIQUID',
    if_else(grepl('LIQUID', presc_raw$DOSAGE_FORM_DESC), 'LIQUID',
    if_else(grepl('CONCENTRATE', presc_raw$DOSAGE_FORM_DESC), 'LIQUID',
    if_else(grepl('SUPPOSITORY', presc_raw$DOSAGE_FORM_DESC), 'SUPPOSITORY', 'NA'
    )))))))))))))

presc_summary = presc %>% group_by(PERSON_ID) %>% summarise(num_presc = n(), 
                                            most_presc_drug = mode_fun(generic_name),
                                            oxy_count = sum(grepl('OXYCODONE', generic_name)),
                                            tram_count = sum(grepl('TRAMADOL', generic_name)),
                                            hydrobit_count = sum(grepl('HYDROCODONE BITARTRATE', generic_name)),
                                            most_dose_form = mode_fun(dosage_form),
                                            pill_count = sum(grepl('PILL', dosage_form)),
                                            patch_count = sum(grepl('PATCH', dosage_form)),
                                            liquid_count = sum(grepl('LIQUID', dosage_form)))




```

